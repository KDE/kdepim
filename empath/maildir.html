<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- Autogenerated by smart.pl on Sun Sep 19 14:56:03 BST 1999 -->
<!-- #config sizefmt=abbrev -->
<HTML><HEAD><TITLE>Maildir manual and notes</TITLE></HEAD>
<BODY BACKGROUND="/gfx/bg.png" BGCOLOR="#ffffff" TEXT="#000000" ALINK="#FF0000" VLINK="#AA4422" LINK="#442222">

 
<TABLE BORDER="0" CELLPADDING="1" CELLSPACING="0" BGCOLOR="#000000" WIDTH="97%"> 
  <TR> 
    <TD> 
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3"> 
        <TR> 
          <TD BGCOLOR="#E6E0D0"> 
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000"> 
              Maildir manual 
            </FONT> 
          </TD> 
          <TD ALIGN="RIGHT" BGCOLOR="#E6E0D0"> 
            <FONT FACE="Lucida,Helvetica" SIZE="-1" COLOR="#000000"> 
              D. J. Bernstein 
            </FONT> 
          </TD> 
        </TR> 
        <TR> 
          <TD BGCOLOR="#E6E0D0"> 
            <FONT FACE="Lucida,Helvetica" COLOR="#000000"> 
              With extra notes by Rik Hemsley <a href="mailto:mailto:rik@kde.org">rik@kde.org</a> 
            </FONT> 
          </TD> 
         <TD ALIGN="RIGHT" BGCOLOR="#E6E0D0"> 
            <FONT FACE="Lucida,Helvetica" SIZE="-1" COLOR="#000000"> 
              Last update: Sun Sep 19 
            </FONT> 
          </TD> 
        </TR> 
      </TABLE> 
    </TD> 
  </TR> 
</TABLE> 
<BR> 


<P>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              Contents 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              <ul>
  <li><a href="#intro">Introduction</a>
  <li><a href="#reliability">Reliability issues</a>
  <li><a href="#structure">The Maildir structure</a>
  <li><a href="#howread">How a message is read</a>
  <li><a href="#envvars">Environment variables</a>
  <li><a href="#addnotes">Additional notes</a>
</ul>
  
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 

<a name="intro"></a>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              Introduction 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              
<i>maildir</i> is a structure for directories of incoming mail messages. It solves the reliability problems that plague <i>mbox</i> files and <i>mh</i> folders.
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>
<a name="reliability"></a>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              Reliability issues 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              

<P>
A machine may crash while it is delivering a message. For both <i>mbox</i> files and <i>mh</i> folders this means that the message will be silently truncated. Even worse: for <i>mbox</i> format, if the message is truncated in the middle of a line, it will be silently joined to the next message. The mail transport agent will try again later to deliver the message, but it is unacceptable that a corrupted message should show up at all. In <i>maildir</i>, every message is guaranteed complete upon delivery.

<P>
A machine may have two programs simultaneously delivering mail to the same user. The <i>mbox</i> and <i>mh</i> formats require the programs to update a single central file. If the programs do not use some locking mechanism, the central file will be corrupted. There are several <i>mbox</i> and <i>mh</i> locking mechanisms, none of which work portably and reliably. In contrast, in <i>maildir</i>, no locks are ever necessary. Different delivery processes never touch the same file.

<P>
A user may try to delete messages from his mailbox at the same moment that the machine delivers a new message. For <i>mbox</i> and <i>mh</i> formats, the user's mail-reading program must know what locking mechanism the mail-delivery programs use. In contrast, in <i>maildir</i>, any delivered message can be safely updated or deleted by a mail-reading program.

<P>
Many sites use Sun's <b>Network Failure System</b> (NFS), presumably because the operating system vendor does not offer anything else. NFS exacerbates all of the above problems. Some NFS implementations don't provide <b>any</b> reliable locking mechanism. With <i>mbox</i> and <i>mh</i> formats, if two machines deliver mail to the same user, or if a user reads mail anywhere except the delivery machine, the user's mail is at risk. <i>maildir</i> works without trouble over NFS.

<P>
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>
<a name="structure"></a>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              The Maildir structure 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              
A directory in <i>maildir</i> format has three subdirectories, all on the same filesystem: tmp, new and cur.

<P>
Each file in <b>new</b> is a newly delivered mail message. The modification time of the file is the delivery date of the message. The message is delivered <i>without</i> an extra UUCP-style <b>From_</b> line, <i>without</i> any <b>&gt;From</b> quoting, and <i>without</i> an extra blank line at the end. The message is normally in RFC 822 format, starting with a <b>Return-Path</b> line and a <b>Delivered-To</b> line, but it could contain arbitrary binary data. It might not even end with a newline.

<P>
Files in <b>cur</b> are just like files in <b>new</b>. The big difference is that files in <b>cur</b> are no longer new mail: they have been seen by the user's mail-reading program.
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              How a message is delivered 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              

<P>
The <b>tmp</b> directory is used to ensure reliable delivery, as discussed here.

<P>
A program delivers a mail message in six steps.

<P>
<ol>

<P>
<li>It <b>chdir()s</b> to the <i>maildir</i> directory.

<P>
<li>It <b>stat()s</b> the name <b>tmp/time.pid.host</b>, where <i>time</i> is the number of seconds since the beginning of 1970 GMT, <i>pid</i> is the program's process ID, and <i>host</i> is the host name.

<P>
<li>If <b>stat()</b> returned anything other than ENOENT, the program sleeps for two seconds, updates <i>time</i> and tries the <b>stat()</b> again, a limited number of times.

<P>
<li>The program creates <b>tmp/time.pid.host</b>.

<P>
<li>The program <i>NFS-writes</i> the message to the file.

<P>
<li>The program <b>link()</b>s the file to <b>new/time.pid.host</b>. At that instant the message has been successfully delivered.

<P>
</ol>

<P>
The delivery program is required to start a 24-hour timer before creating <b>tmp/time.pid.host</b>, and to abort the delivery if the timer expires.
Upon error, timeout, or normal completion, the delivery program may attempt to <b>unlink()</b> <b>tmp/time.pid.host</b>.

<P>
<i>NFS-writing</i> means

<P>
<ol>
<li>as usual, checking the number of bytes returned from each <b>write()</b> call;
<li>calling <b>fsync()</b> and checking its return value;
<li>calling <b>close()</b> and checking its return value.

<P>
</ol>

<P>
<b>Note</b>: Standard NFS implementations handle <b>fsync()</b> incorrectly but make up for it by abusing <b>close()</b>.

<P>
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>
<a name="howread"></a>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              How a message is read 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              

<P>
A mail reader operates as follows.

<P>
It looks through the <b>new</b> directory for new messages.

<P>
Say there is a new message, <b>new/unique</b>. The reader may freely display the contents of <b>new/unique</b>, delete <b>new/unique</b>, or rename <b>new/unique</b> as <b>cur/unique:info</b>. See <a href="http://pobox.com/~djb/proto/maildir.html">here</a> for the meaning of <i>info</i>. 

<P>
The reader is also expected to look through the <b>tmp</b> directory and to clean up any old files found there.
A file in <b>tmp</b> may be safely removed if it has not been accessed in 36 hours.

<P>
It is a good idea for readers to skip all filenames in <b>new</b> and <b>cur</b> starting with a dot.
Other than this, readers should not attempt to parse filenames.

<P>
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>
<a name="envvars"></a>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              Environment variables 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              

<P>
Mail readers supporting <i>maildir</i> use the <b>MAILDIR</b> environment variable as the name of the user's primary mail directory.

<P>
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>
<a name="addnotes"></a>

<TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0 BGCOLOR="#000000" WIDTH=97%>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#E6E0D0">
            <FONT FACE="Lucida,Helvetica" SIZE="+1" COLOR="#000000">
              Additional notes [by Rik] 
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD>
      <TABLE WIDTH="100%" BORDER="0" CELLSPACING="0" CELLPADDING="3">
        <TR>
          <TD BGCOLOR="#FFFFF5">
            <FONT FACE="Lucida,Helvetica" COLOR=@fg2>
              <BR>
              
To have mail delivered to a <i>maildir</i> format box, you need some form of Mail Delivery Agent (<i>MDA</i>) that understands the <i>maildir</i> format.

<P>
Note that most mail clients actually act as <i>MDA</i>s, even though they're given the term <i>MUA</i> (Mail User Agent). A pure <i>IMAP4</i> client doesn't count, as it doesn't actually deliver anything to a mailbox, it asks the <i>IMAP</i> server to do it. Examples of <i>maildir</i>-aware <i>MUA</i>s are <a href="http://www.mutt.org">mutt</a> and <a href="http://without.netpedia.net">Empath</a>

<P>
If you want to have mail delivered by your <i>MTA</i> (Message Transmission Agent, e.g. <i>sendmail</i>), you'll have to use either <i>qmail</i> (a safe, secure, fast, <i>sendmail</i> replacement), which is the only <i>MTA</i> currently available which is capable of writing directly to <i>maildir</i>, or use something to replace the standard <i>MDA</i> behaviour of your <i>MTA</i>. At the time of writing there is only one such utility, <i>maildrop</i> which is similar to <i>procmail</i> - the traditional mail delivery and filtering agent.

<P>
Instructions for setting up and using <i>qmail</i> and <i>maildrop</i> are included with the respective packages. It's a great deal easier to set up <i>maildrop</i> than <i>qmail</i>, though I'd recommend moving your site to <i>qmail</i> if you don't need <i>sendmail</i>'s extra functionality and care about mail security and safety.

<P>
 
              <BR>
            </FONT>
          </TD>
        </TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
<BR> 


<P>

</BODY></HTML>
