<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2K.1beta (1.48)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>A very simple conduit: malconduit</TITLE>
<META NAME="description" CONTENT="A very simple conduit: malconduit">
<META NAME="keywords" CONTENT="index">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Generator" CONTENT="LaTeX2HTML v2K.1beta">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="index.css">

<LINK REL="next" HREF="node22.html">
<LINK REL="previous" HREF="node16.html">
<LINK REL="up" HREF="index.html">
<LINK REL="next" HREF="node22.html">
</HEAD>

<BODY >
<!--Navigation Panel-->
<A NAME="tex2html322"
  HREF="node22.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html318"
  HREF="index.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html312"
  HREF="node20.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html320"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html323"
  HREF="node22.html">A per-file conduit: docconduit</A>
<B> Up:</B> <A NAME="tex2html319"
  HREF="index.html">KPilot conduit programming tutorial</A>
<B> Previous:</B> <A NAME="tex2html313"
  HREF="node20.html">The PilotRecord classes for</A>
 &nbsp <B>  <A NAME="tex2html321"
  HREF="node1.html">Contents</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->

<H1><A NAME="SECTION00060000000000000000"></A><A NAME="SectionSimpleConduit"></A>
<BR>
A very simple conduit: malconduit
</H1>

<P>
To have a working conduit, we still have to implement the synchronization 
itself. For the AvantGo conduit there already exists a library named 
"libmal" which does all the synchronization for us. In the section on 
autoconf and automake I already described the configure commands to check 
for the library and to link to the library on runtime (the <FONT SIZE="-1"><TT>-lmal</TT></FONT> 
flag stored in the variable <FONT SIZE="-1"><TT>$(MAL_LIB)</TT></FONT> ).

<P>
When using the libmal library, all we have to do is to make some proxy settings, and then call the function <TT>malsync( pilotSocket(), pInfo);</TT>, which will do the actual sync for us:
<PRE>
void MALConduit::readConfig() {
  FUNCTIONSETUP;
  QDateTime dt;
  KConfigGroupSaver g(fConfig, MALConduitFactory::group());
  fLastSync = fConfig-&gt;readDateTimeEntry(MALConduitFactory::lastSync(), &amp;dt);
  DEBUGCONDUIT&lt;&lt;"Last sync was "&lt;&lt;fLastSync.toString()&lt;&lt;endl;

  eSyncTime=fConfig-&gt;readNumEntry(MALConduitFactory::syncTime(), 0);
  
  // Proxy settings
  eProxyType=fConfig-&gt;readNumEntry(MALConduitFactory::proxyType(), 0);
  fProxyServer=fConfig-&gt;readEntry(MALConduitFactory::proxyServer(), "");

  fProxyPort=fConfig-&gt;readNumEntry(MALConduitFactory::proxyPort(), 0);
  fProxyUser=fConfig-&gt;readEntry(MALConduitFactory::proxyUser(), "");
  fProxyPassword=fConfig-&gt;readEntry(MALConduitFactory::proxyPassword(), "");
}



void MALConduit::saveConfig() {
  FUNCTIONSETUP;
  KConfigGroupSaver g(fConfig, MALConduitFactory::group());
  fConfig-&gt;writeEntry(MALConduitFactory::lastSync(), QDateTime::currentDateTime());
}



bool MALConduit::skip() {
  QDateTime now=QDateTime::currentDateTime();
  if (!fLastSync.isValid() || !now.isValid()) return false;

  switch (eSyncTime) {
    case eEveryHour:
        if ( (fLastSync.secsTo(now)&lt;=3600) &amp;&amp; (fLastSync.time().hour()==now.time().hour()) ) return true;
        else return false;
    case eEveryDay:
        if ( fLastSync.date() == now.date() ) return true;
        else return false;
    case eEveryWeek:
        if ( (fLastSync.daysTo(now)&lt;=7)  &amp;&amp; ( fLastSync.date().dayOfWeek()&lt;=now.date().dayOfWeek()) ) return true;
        else return false;
    case eEveryMonth:
        if ( (fLastSync.daysTo(now)&lt;=31) &amp;&amp; (fLastSync.date().month()==now.date().month()) ) return true;
        else return false;
    case eEverySync:
    default:
        return false;
  }
  return false;
}



/* virtual */ bool MALConduit::exec() {
  FUNCTIONSETUP;

  if (!fConfig) {
    kdWarning() &lt;&lt; k_funcinfo &lt;&lt; ": No config file was set!" &lt;&lt; endl;
    return false;
  }

  readConfig();
  
  if (skip())  {
    emit logMessage(i18n("Skipping MAL sync, because last synchronization was not long enough ago."));
    emit syncDone(this);
    return true;
  }
  
  // Set all proxy settings
  switch (eProxyType) {
    case eProxyHTTP:
        if (fProxyServer.isEmpty()) break;
        setHttpProxy(fProxyServer.latin1());
        if (fProxyPort&gt;0 &amp;&amp; fProxyPort&lt;65536) setHttpProxyPort( fProxyPort );
        else setHttpProxyPort(80);
      
        if (!fProxyUser.isEmpty()) {
          setProxyUsername( fProxyUser.latin1() );
          if (!fProxyPassword.isEmpty()) setProxyPassword( fProxyPassword.latin1() );
        }
        break;
    case eProxySOCKS:
        setSocksProxy( fProxyServer.latin1() );
        if (fProxyPort&gt;0 &amp;&amp; fProxyPort&lt;65536) setSocksProxyPort( fProxyPort );
        else setSocksProxyPort(1080);
        break; 
    default:
        break;
  }


  // Now initiate the sync.
  PalmSyncInfo* pInfo=syncInfoNew();
  if (!pInfo) {
    kdWarning() &lt;&lt; k_funcinfo &lt;&lt; ": Could not allocate SyncInfo!" &lt;&lt; endl;
    emit logError(i18n("MAL synchronization failed (no SyncInfo)."));
    return false;
  }
  malsync( pilotSocket(), pInfo);
  syncInfoFree(pInfo);

  saveConfig();
  emit syncDone(this);
  return true;
}
</PRE>

<P>
When you use an external library to do the sync, the external functions need a reference to the current connection to the handheld. In the pilot-link library, which is the base for all of KPilot's communication with the handheld, this is implemented via an integer identifier, which can be obtained by the funciton <TT>pilotSocket()</TT> of the SyncAction class.

<P>
The libmal also needs some internal data structed "PalmSyncInfo", which is obtained by its own syncInfoNew() function, but this part is libmal-specific.

<P>
Another issue is how to propagate log messages from the external library to KPilot's log window. SyncAction provides slots logError, logMessage and logProgress to put messages into KPilot's sync log. All you have to do is to call
<PRE>
emit logMessage(i18n("My own log message"));
</PRE>

<P>
The problem with these slots is that they are Qt-specific, while most libraries are written in C, and expect a hook function that will be called whenever a message needs to be written out. Unfortunately you cannot pass a member of your SyncAction-derived class, either, so the way out is to store a pointer to the current conduit instance (only one will be active at any time, anyway) in a static variable, and call the member method from this pointer:

<P>
<PRE>
// static pointer to the current conduit instance
static MALConduit *conduitInstance=0L;

// The hook function which will be called by the library
int malconduit_logf(const char *format, ...) {
  FUNCTIONSETUP;
  va_list val;
  int rval;
  va_start(val, format);
#define WRITE_MAX_BUF  4096
  char msg[WRITE_MAX_BUF];
  msg[0]='\0';
  rval=vsnprintf(&amp;msg[0], sizeof(msg), format, val);
  va_end(val);
  if (rval == -1) {
    msg[WRITE_MAX_BUF-1] = '\0';
    rval=WRITE_MAX_BUF-1;
  }
  if (conduitInstance) {
    conduitInstance-&gt;printLogMessage(msg);
  } else {
    // write out to stderr
    kdWarning()&lt;&lt;msg&lt;&lt;endl;
  }
  return rval;
}

void MALConduit::printLogMessage(QString msg) {
  FUNCTIONSETUP;
  emit logMessage(msg);
}

// Here we have to set the hooks for libmal to call.
MALConduit::MALConduit(KPilotDeviceLink * o,
  const char *n, 
  const QStringList &amp; a) :
  ConduitAction(o, n, a)
{
  FUNCTIONSETUP;
  register_printStatusHook(malconduit_logf);
  register_printErrorHook(malconduit_logf);
  conduitInstance=this;
  (void) MAL_conduit_id;
}
</PRE>

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html322"
  HREF="node22.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html318"
  HREF="index.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html312"
  HREF="node20.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html320"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html323"
  HREF="node22.html">A per-file conduit: docconduit</A>
<B> Up:</B> <A NAME="tex2html319"
  HREF="index.html">KPilot conduit programming tutorial</A>
<B> Previous:</B> <A NAME="tex2html313"
  HREF="node20.html">The PilotRecord classes for</A>
 &nbsp <B>  <A NAME="tex2html321"
  HREF="node1.html">Contents</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
Reinhold Kainhofer
2003-01-13
</ADDRESS>
</BODY>
</HTML>
